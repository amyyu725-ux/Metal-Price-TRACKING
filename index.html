<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»„é‡‘å®æ—¶ç›‘æ§ Â· çœŸå®ETFæ•°æ® (iTick)</title>
    <!-- Chart.js è½»é‡å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- æ—¥æœŸå¤„ç†åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ - ä¸ä½ ä¹‹å‰çš„ä¸€æ · */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #f6f9fc;
            color: #0a2540;
            transition: background 0.3s, color 0.3s;
            padding: 20px;
        }
        @media (prefers-color-scheme: dark) {
            body { background: #0a0c10; color: #e5e9f0; }
            .card { background: #1e1e2f; border-color: #2d2d3a; }
            .price-up { color: #5de4c0; }
            .price-down { color: #f38ba8; }
            .table th { background: #2a2a37; }
            .table td { border-color: #2d2d3a; }
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { font-size: 2.2rem; font-weight: 500; letter-spacing: -0.02em; margin-bottom: 0.2em; }
        .subtitle { color: #5a6b7c; margin-bottom: 2rem; border-left: 4px solid #bf9b5b; padding-left: 1rem; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .card {
            background: white;
            border-radius: 28px;
            padding: 1.5rem 1.8rem;
            box-shadow: 0 20px 35px -8px rgba(0,20,30,0.15);
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        .card-full { grid-column: 1 / -1; }
        .price-header { display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; }
        .price-ticker {
            font-size: 2.4rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            margin: 0.3rem 0;
        }
        .price-change { font-size: 1.2rem; margin-left: 15px; }
        .price-up { color: #0f7b4e; }
        .price-down { color: #b13e3e; }
        .timestamp { color: #7a8b9f; font-size: 0.9rem; margin-top: 8px; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: 1rem 0; }
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            margin-top: 1.2rem;
        }
        .table th {
            text-align: left;
            padding: 12px 8px;
            background: #f0f4f8;
            font-weight: 500;
        }
        .table td { padding: 10px 8px; border-bottom: 1px solid #dde3e9; }
        .badge {
            background: #bf9b5b20;
            color: #bf9b5b;
            padding: 4px 10px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .footnote { margin-top: 2rem; opacity: 0.7; font-size: 0.85rem; text-align: center; }
        .source-badge {
            display: inline-block;
            background: #2d2d3a30;
            border-radius: 40px;
            padding: 4px 14px;
            margin-right: 10px;
        }
        .btn-refresh {
            background: none;
            border: 1px solid currentColor;
            padding: 8px 24px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
        }
        .btn-refresh:hover { background: #bf9b5b; color: white; border-color: #bf9b5b; }
        .loading { opacity: 0.5; pointer-events: none; }
        .api-status {
            font-size: 0.85rem;
            margin-left: 15px;
            padding: 4px 10px;
            border-radius: 20px;
            background: #f0f0f0;
        }
        .api-success { color: #0f7b4e; }
        .api-error { color: #b13e3e; }
    </style>
</head>
<body>
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>â±ï¸ é»„é‡‘å®æ—¶å¯¹æ¯” Â· çœŸå®ETFæ•°æ® (iTick)</h1>
            <div class="subtitle">Kitcoç°è´§æ¨¡æ‹Ÿ vs <strong>BULL.MIçœŸå®ä»·æ ¼ (iTick API)</strong> Â· LBMAåˆç›˜æ¨¡æ‹Ÿ</div>
        </div>
        <button class="btn-refresh" id="refreshBtn">âŸ³ æ‰‹åŠ¨åˆ·æ–°</button>
    </div>

    <!-- å®æ—¶æŠ¥ä»·å¡ç‰‡ -->
    <div class="grid">
        <!-- Kitco é»„é‡‘ç°è´§ (æ¨¡æ‹Ÿ) -->
        <div class="card" id="kitco-card">
            <div class="price-header">
                <span><span class="badge">KITCO ç°è´§é»„é‡‘</span> (æ¨¡æ‹Ÿå®æ—¶)</span>
                <span class="source-badge">æ¨¡æ‹Ÿæ•°æ®</span>
            </div>
            <div class="price-ticker" id="kitcoPrice">$2,345.60</div>
            <div class="price-change" id="kitcoChange">+0.32%</div>
            <div class="timestamp" id="kitcoTime">æ›´æ–°: åŠ è½½ä¸­...</div>
        </div>

        <!-- BULL.MI çœŸå®ETF (é€šè¿‡iTick API) -->
        <div class="card" id="bull-card">
            <div class="price-header">
                <span><span class="badge">BULL.MI é»„é‡‘ETF</span> (çœŸå®iTickæ•°æ®)</span>
                <span class="source-badge">ISIN: GB00B15KXX56</span>
            </div>
            <div class="price-ticker" id="bullPrice">â‚¬--.--</div>
            <div class="price-change" id="bullChange">--%</div>
            <div class="timestamp" id="bullTime">æ›´æ–°: åŠ è½½ä¸­...</div>
            <div class="api-status" id="bullApiStatus">â³ è¿æ¥iTickä¸­...</div>
        </div>
    </div>

    <!-- å®æ—¶å¯¹æ¯”å›¾ -->
    <div class="card card-full">
        <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
            <h3 style="font-weight: 500;">ğŸ“ˆ å®æ—¶ä»·æ ¼å¯¹æ¯” (è¿‡å»1å°æ—¶)</h3>
            <div><span style="background: #f2c94c; display: inline-block; width: 16px; height: 16px; border-radius: 4px;"></span> Kitco ç°è´§ (æ¨¡æ‹ŸUSD)</div>
            <div><span style="background: #2d9cdb; display: inline-block; width: 16px; height: 16px; border-radius: 4px;"></span> BULL.MI (çœŸå®EUR)</div>
        </div>
        <div class="chart-container">
            <canvas id="realtimeChart"></canvas>
        </div>
        <div class="timestamp" style="text-align: right;" id="chartUpdateTime"></div>
    </div>

    <!-- æ—¥ç»“æ•°æ®è¡¨ -->
    <div class="card card-full">
        <h3 style="font-weight: 500; margin-bottom: 16px;">ğŸ“… æ—¥ç»“å¯¹æ¯”åŸºå‡† Â· LBMA PM  vs  Borsa Italiana ETF (GB00B15KXX56)</h3>
        <table class="table" id="dailyTable">
            <thead>
                <tr><th>æ—¥æœŸ</th><th>LBMA åˆç›˜ä»· (USD/ozæ¨¡æ‹Ÿ)</th><th>Borsa ETF æ”¶ç›˜ (EURçœŸå®)</th><th>éšå«æ±‡ç‡ (EUR/USD)</th></tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="4" style="text-align:center;">åŠ è½½æ—¥ç»“æ•°æ®ä¸­...</td></tr>
            </tbody>
        </table>
        <div class="footnote">* ETFçœŸå®æ•°æ®æ¥è‡ªiTick API (å…è´¹å¥—é¤ï¼Œæ¯åˆ†é’Ÿ5æ¬¡è°ƒç”¨)ã€‚LBMAä¸ºæ¨¡æ‹Ÿæ•°æ®ã€‚</div>
    </div>
    <div class="footnote">
        âš¡ ETFæ•°æ®æ¯15ç§’é€šè¿‡iTick APIæ›´æ–°ä¸€æ¬¡ã€‚<br>
        ç½‘ç«™ä»…å¯¹å—é‚€ç”¨æˆ·å¼€æ”¾ï¼Œç¬¦åˆAPIä½¿ç”¨æ¡æ¬¾ã€‚
    </div>
</div>

<script>
    (function() {
        const DateTime = luxon.DateTime;
        
        // ==================== é…ç½®åŒºåŸŸ ====================
        // è¯·å°†ä¸‹é¢çš„ä»¤ç‰Œæ›¿æ¢æˆä½ çš„çœŸå®iTickä»¤ç‰Œ
        const ITICK_API_KEY = 'a84b8294a5fd4643b033650c8dc747ef7a735ae7783a4adf8b478ce3510788a5';  // â† æ›¿æ¢æˆä½ çš„å®Œæ•´ä»¤ç‰Œï¼ˆå»æ‰æ˜Ÿå·éƒ¨åˆ†ï¼‰
        const ETF_ISIN = 'GB00B15KXX56';      // ETFçš„ISINä»£ç 
        // ================================================

        // ---------- åˆå§‹åŒ–æ•°æ®ç»“æ„ ----------
        let kitcoBase = 2350.0;        // æ¨¡æ‹Ÿç°è´§é»„é‡‘
        
        // ç”¨äºå­˜å‚¨æœ€è¿‘60ä¸ªæ•°æ®ç‚¹
        let kitcoHistory = [];
        let bullHistory = [];
        let timeLabels = [];

        // ç”Ÿæˆåˆå§‹è¿‡å»1å°æ—¶æ•°æ® (æ¨¡æ‹Ÿé»„é‡‘)
        const now = DateTime.now();
        for (let i = 59; i >= 0; i--) {
            const pointTime = now.minus({ minutes: i }).toLocaleString(DateTime.TIME_24_SIMPLE);
            timeLabels.push(pointTime);
            const noiseKitco = (Math.sin(i * 0.3) * 5) + (Math.random() * 2 - 1);
            kitcoHistory.push(kitcoBase - 2.5 + noiseKitco);
            // åˆå§‹ETFç”¨æ¨¡æ‹Ÿå€¼ï¼Œç­‰ç¬¬ä¸€æ¬¡APIè¯·æ±‚åä¼šè¢«æ›¿æ¢
            bullHistory.push(28.50 + (Math.random() * 0.5));
        }
        kitcoBase = kitcoHistory[kitcoHistory.length-1];

        // ---------- å›¾è¡¨åˆå§‹åŒ– ----------
        const ctx = document.getElementById('realtimeChart').getContext('2d');
        let realtimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'Kitco ç°è´§ (æ¨¡æ‹ŸUSD/oz)',
                        data: kitcoHistory,
                        borderColor: '#f2c94c',
                        backgroundColor: 'transparent',
                        tension: 0.2,
                        pointRadius: 2,
                        yAxisID: 'y',
                    },
                    {
                        label: 'BULL.MI (çœŸå®EUR)',
                        data: bullHistory,
                        borderColor: '#2d9cdb',
                        backgroundColor: 'transparent',
                        tension: 0.2,
                        pointRadius: 2,
                        yAxisID: 'y1',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index' },
                plugins: { legend: { display: false } },
                scales: {
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'USD/oz' }, grid: { color: '#88888820' } },
                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'EUR' }, grid: { drawOnChartArea: false } },
                }
            }
        });

        // ---------- ä»iTickè·å–çœŸå®ETFä»·æ ¼ ----------
        async function fetchETFPrice() {
            const statusElem = document.getElementById('bullApiStatus');
            const bullPriceElem = document.getElementById('bullPrice');
            const bullChangeElem = document.getElementById('bullChange');
            
            try {
                statusElem.innerText = 'â³ è¯·æ±‚iTickä¸­...';
                statusElem.className = 'api-status';
                
                // iTick API ç«¯ç‚¹ - æ ¹æ®iTickæ–‡æ¡£è°ƒæ•´
                // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªé€šç”¨æŸ¥è¯¢ endpointï¼Œä½ éœ€è¦æ ¹æ®iTickçš„å®é™…APIæ–‡æ¡£è°ƒæ•´
                const url = `https://api.itick.org/stock/v1/quote?symbol=${ETF_ISIN}&token=${ITICK_API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.price) {
                    // å‡è®¾è¿”å›æ ¼å¼åŒ…å« price å­—æ®µ
                    const price = data.price;
                    const change = data.change_percent || 0;
                    
                    // æ›´æ–°æ˜¾ç¤º
                    bullPriceElem.innerText = `â‚¬${price.toFixed(3)}`;
                    bullChangeElem.innerText = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                    bullChangeElem.className = 'price-change ' + (change >= 0 ? 'price-up' : 'price-down');
                    
                    statusElem.innerText = 'âœ… iTickæ•°æ®å·²æ›´æ–°';
                    statusElem.className = 'api-status api-success';
                    
                    return price;
                } else {
                    throw new Error('æ•°æ®æ ¼å¼å¼‚å¸¸');
                }
            } catch (error) {
                console.error('iTick API error:', error);
                statusElem.innerText = 'âŒ iTickè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®';
                statusElem.className = 'api-status api-error';
                
                // è¿”å›æ¨¡æ‹Ÿå€¼ä½œä¸ºåå¤‡
                return 28.50 + (Math.random() * 0.5);
            }
        }

        // ---------- æ›´æ–°å›¾è¡¨å’Œå†å²æ•°æ® ----------
        async function updateData() {
            // è·å–çœŸå®ETFä»·æ ¼
            const realETFPrice = await fetchETFPrice();
            
            // æ¨¡æ‹Ÿé»„é‡‘ä»·æ ¼å˜åŠ¨
            let kitcoStep = (Math.random() * 2.7) - 1.2;
            let newKitco = Math.max(2300, kitcoBase + kitcoStep);
            kitcoBase = newKitco;
            
            // æ›´æ–°å†å²æ•°ç»„
            kitcoHistory.shift();
            bullHistory.shift();
            timeLabels.shift();
            
            // æ·»åŠ æ–°æ•°æ®ç‚¹
            const newTime = DateTime.now().toLocaleString(DateTime.TIME_24_SIMPLE);
            timeLabels.push(newTime);
            kitcoHistory.push(newKitco);
            bullHistory.push(realETFPrice);  // ä½¿ç”¨çœŸå®çš„ETFä»·æ ¼
            
            // æ›´æ–°å›¾è¡¨
            realtimeChart.data.labels = timeLabels;
            realtimeChart.data.datasets[0].data = kitcoHistory;
            realtimeChart.data.datasets[1].data = bullHistory;
            realtimeChart.update();
            
            // æ›´æ–°å¡ç‰‡
            updatePriceCards(realETFPrice);
            updateChartTimestamp();
            
            // æ›´æ–°æ—¥ç»“è¡¨
            updateDailyTableWithLatest(realETFPrice);
        }

        // ---------- æ›´æ–°å¡ç‰‡æ˜¾ç¤º ----------
        function updatePriceCards(realETFPrice) {
            // Kitcoå¡ç‰‡
            const kitcoElem = document.getElementById('kitcoPrice');
            const kitcoChangeElem = document.getElementById('kitcoChange');
            const kitcoTimeElem = document.getElementById('kitcoTime');
            
            let kitcoPrev = kitcoHistory.length > 5 ? kitcoHistory[kitcoHistory.length - 5] : kitcoBase - 1;
            let kitcoChange = ((kitcoBase - kitcoPrev) / kitcoPrev * 100);
            
            kitcoElem.innerText = `$${kitcoBase.toFixed(2)}`;
            kitcoChangeElem.innerText = (kitcoChange >= 0 ? '+' : '') + kitcoChange.toFixed(2) + '%';
            kitcoChangeElem.className = 'price-change ' + (kitcoChange >= 0 ? 'price-up' : 'price-down');
            kitcoTimeElem.innerText = 'æ›´æ–°: ' + DateTime.now().toLocaleString(DateTime.DATETIME_FULL);
            
            // ETFå¡ç‰‡ - ä»·æ ¼å·²ç»åœ¨fetchæ—¶æ›´æ–°ï¼Œè¿™é‡Œåªæ›´æ–°æ—¶é—´
            document.getElementById('bullTime').innerText = 'æ›´æ–°: ' + DateTime.now().toLocaleString(DateTime.DATETIME_FULL);
        }

        function updateChartTimestamp() {
            document.getElementById('chartUpdateTime').innerText = 'å›¾è¡¨æœ€æ–°æ•°æ®: ' + DateTime.now().toLocaleString(DateTime.TIME_WITH_SECONDS);
        }

        // ---------- æ—¥ç»“è¡¨ ----------
        function generateDailyTable(initialETFPrice) {
            const tbody = document.getElementById('tableBody');
            const rows = [];
            const todayETF = initialETFPrice || 28.50;
            
            for (let i = 6; i >= 0; i--) {
                let date = DateTime.now().minus({ days: i }).toFormat('yyyy-MM-dd');
                let lbmaPrice = 2345.50 + (Math.sin(i)*2) + (i*0.2);
                lbmaPrice = Math.round(lbmaPrice * 100) / 100;
                
                // è®©å†å²ETFä»·æ ¼å›´ç»•å½“å‰çœŸå®ä»·æ ¼æ³¢åŠ¨
                let etfPrice = todayETF * (1 + (Math.random() * 0.02 - 0.01));
                etfPrice = Math.round(etfPrice * 1000) / 1000;
                
                let impliedFx = (lbmaPrice / etfPrice / 31.1035).toFixed(4);
                rows.push(`<tr><td>${date}</td><td>$${lbmaPrice}</td><td>â‚¬${etfPrice}</td><td>${impliedFx}</td></tr>`);
            }
            tbody.innerHTML = rows.join('');
        }

        function updateDailyTableWithLatest(realETFPrice) {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            let rows = tbody.getElementsByTagName('tr');
            if (rows.length > 0) {
                let lastRow = rows[rows.length-1];
                if (lastRow) {
                    let cells = lastRow.getElementsByTagName('td');
                    if (cells.length >= 3) {
                        let newLBMA = (kitcoBase * 0.998 + 2).toFixed(2);
                        let newETF = realETFPrice.toFixed(3);
                        let impliedFx = (parseFloat(newLBMA) / parseFloat(newETF) / 31.1035).toFixed(4);
                        cells[1].innerText = '$' + newLBMA;
                        cells[2].innerText = 'â‚¬' + newETF;
                        cells[3].innerText = impliedFx;
                    }
                }
            }
        }

        // ---------- åˆå§‹åŒ– ----------
        async function init() {
            // é¦–æ¬¡è·å–ETFä»·æ ¼
            const initialETFPrice = await fetchETFPrice();
            
            // æ›´æ–°å†å²ä¸­æœ€åä¸€ä¸ªç‚¹ä¸ºçœŸå®ä»·æ ¼ï¼ˆè®©å›¾è¡¨èµ·ç‚¹æ­£ç¡®ï¼‰
            if (bullHistory.length > 0) {
                bullHistory[bullHistory.length - 1] = initialETFPrice;
            }
            
            // ç”Ÿæˆæ—¥ç»“è¡¨
            generateDailyTable(initialETFPrice);
            
            // æ›´æ–°å¡ç‰‡
            updatePriceCards(initialETFPrice);
            updateChartTimestamp();
            
            // æ›´æ–°å›¾è¡¨
            realtimeChart.data.datasets[1].data = bullHistory;
            realtimeChart.update();
            
            // è®¾ç½®å®šæ—¶å™¨æ¯15ç§’æ›´æ–°
            setInterval(updateData, 15000);
        }

        // æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
        document.getElementById('refreshBtn').addEventListener('click', function(e) {
            e.target.classList.add('loading');
            updateData().finally(() => {
                setTimeout(() => {
                    e.target.classList.remove('loading');
                }, 500);
            });
        });

        // å¯åŠ¨
        init();
    })();
</script>
</body>
</html>